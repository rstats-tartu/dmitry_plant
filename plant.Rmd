---
title: "Plant project"
output: github_document
---

## Load libraries

```{r warning=FALSE, message=FALSE, error=FALSE}
library(tidyverse)
library(lubridate)
library(skimr)
library(viridis)
```

## Import data

QY_max - max quantum yield
```{r}
fc <- read_delim("data/Fc.csv", delim = ";", locale = locale(decimal_mark = ","))
fc <- select(fc, date, time, tray_id, plant_id, position, cond = plant_name, genotype, qymax = QY_max) %>% drop_na()
```


```{r}
skim(fc)
```

Trays and experimental conditions. Tray id contains also info about exp condition
```{r}
unique(fc$tray_id)
unique(fc$cond)
```


We can see that we have negative values in qymax!

**PLEASE PRINT OUT THE ROWS WITH 10 LOWEST QT_MAX NUMBERS** Can QY be negative?

```{r}
top_n(fc, 10, desc(qymax))
```

There are negative QY! which are impossible, let's filter them out:
```{r}
fc <- filter(fc, qymax > 0)
```

Calculate timepoints in days and keep only tray id (first) part from tray_id-s and same for cond:
```{r}
fc <- fc %>% 
  mutate(dtm = ymd_hms(str_c(date, time)),
         tray_id = str_extract(tray_id, "^ES\\d+_\\d+"),
         cond = str_replace(cond, "LC_LT_", "")) %>% 
  group_by(plant_id) %>% 
  mutate(day = as.numeric(difftime(dtm, min(dtm), units = "days"))) %>% 
  select(date, time, day, plant_id, cond, genotype, qymax, tray_id, position)
```

Let's have look at the tray by tray variation
```{r}
ggplot(data = fc) +
  geom_histogram(mapping = aes(x = qymax), bins = 30) +
  facet_wrap(~ str_c(tray_id, cond, sep = " "))
```

```{r}
ggplot(data = fc) +
  geom_line(mapping = aes(x = day, y = qymax, group = plant_id)) +
  facet_wrap(~ str_c(tray_id, cond, sep = " "))
```

By condition:
```{r}
ggplot(data = fc) +
  geom_line(mapping = aes(x = day, y = qymax, group = plant_id, color = genotype), size = 0.2) +
  facet_wrap(~ cond) +
  scale_color_viridis_d()
```

Genotypes seem to mix, apparently bigger differences between environmental conditions .


**PLEASE DO A FACETED HISTOGRAM ACCROSS MUTANTS~EXP CONDITIONS**
```{r}
ggplot(data = fc) +
  geom_histogram(mapping = aes(x = qymax), bins = 30) +
  facet_grid(cond ~ genotype)
```

Now let's make grid of line plots for each tray position. Here we don't even need to use mutate, we can use str_extract within facet_grid to get row and col ids ("\\w" is regular expression for word/character and "\\d" is for digits):
```{r}
ggplot(data = fc) +
  geom_line(mapping = aes(x = day, y = qymax, group = plant_id, color = genotype), size = 0.2) +
  facet_grid(str_extract(position, "\\w") ~ str_extract(position, "\\d")) +
  scale_color_viridis_d()
```


## Mean temperature

```{r}
ir <- read_delim("data/Ir.csv", delim = ";", locale = locale(decimal_mark = ","))
ir <- select(ir, date, plant_id, plant_name, genotype, temp = "Temp-avg") %>% 
  filter(genotype != "empty") %>% 
  drop_na()
```

```{r}
ggplot(data = ir) +
  geom_histogram(mapping = aes(x = temp), bins = 30) +
  facet_grid(plant_name ~ genotype)
```


## Morpho - area in mm
```{r}
morpho <- read_delim("data/Morpho.csv", delim = ";", locale = locale(decimal_mark = ","))
morpho <- select(morpho, date, plant_id, plant_name, genotype, area = AREA_MM) %>% 
  filter(genotype != "empty") %>% 
  drop_na()
```


```{r}
ggplot(data = morpho) +
  geom_histogram(mapping = aes(x = area), bins = 30) +
  facet_grid(plant_name ~ genotype)
```


## Weight in grams

```{r}
measure <- read_delim("data/Measure.csv", delim = ";", locale = locale(decimal_mark = ","))
measure <- select(measure, date, plant_id, plant_name, genotype, weight) %>% 
  filter(genotype != "empty")
```



```{r}
ggplot(data = measure) +
  geom_histogram(mapping = aes(x = weight), bins = 30) +
  facet_grid(plant_name ~ genotype)
```

## Merge measured variables
Join df-s, which have some common variables (with identical column names), and some separate variables. By default the final df has every variable once (but this can be changed - see ?join).
```{r}
plant <- inner_join(fc, ir) %>% 
  inner_join(morpho) %>% 
  inner_join(weight)
```

While ir and morpho have 5040 obs, measure has 5060. Why is that?
```{r}
weight %>% 
  group_by(date, plant_id, plant_name, genotype) %>% 
  summarise(N = n())
```

In the measure df there is a single time point where weigth is measured twice - lets proceed with the mean weigth then.
```{r}
measure <- measure %>% 
  group_by(date, plant_id) %>% 
  summarise(weight = mean(weight))
plant <- plant %>% left_join(measure)
```

## Variables by experimental condition

### Temp
```{r}
plant %>% 
  ggplot(mapping = aes(x = date, y = temp, color = genotype)) + 
  geom_jitter(size = 0.2) +
  facet_wrap(~plant_name)
```

### QY
```{r}
plant %>% 
  ggplot(mapping = aes(x = date, y = QY_max, color = genotype)) + 
  geom_jitter(size = 0.2) +
  facet_wrap(~plant_name)
```
Siin juhtub midagi huvitavat LC_LT_LW_HL paneelil - varieeruvus kahaneb ja kasvab jälle. Kas QY -4 on võimalik?

### Area
```{r}
plant %>% 
  ggplot(aes(x = date, y = area, color = genotype)) + 
  geom_jitter(size = 0.2) +
  facet_wrap(~plant_name)
```

### Weigth
```{r}
plant %>% 
  ggplot(aes(x = date, y = weight, color = genotype)) + 
  geom_jitter(size = 0.2) +
  facet_wrap(~plant_name)
```


Making the plant name more readable by removing the redundant part
```{r}
levels(factor(plant$plant_name))
```


```{r}
plant <- mutate(plant, plant_name = str_replace(plant_name, "LC_LT_", ""))
```

Siin kõik punktid, aga plotime keskmised:
```{r}
plant_gt <- plant %>% 
  group_by(date, plant_name, genotype) %>% 
  summarise(qy = mean(QY_max), 
            temp = mean(temp), 
            area = mean(area), 
            weight = mean(weight))
(p <- ggplot(data = plant_gt) + 
  aes(x = date, y = temp, color = plant_name) +
  geom_line() +
  facet_wrap(~genotype))
```

QY
```{r}
ggplot(data = plant_gt, mapping = aes(x = date, y = qy, color = plant_name)) + 
  geom_line() +
  facet_wrap(~genotype)
```

```{r}
ggplot(data = plant_gt, mapping = aes(x = date, y = area, color = plant_name)) + 
  geom_line() +
  facet_wrap(~genotype)
```

```{r}
ggplot(data = plant_gt, mapping = aes(x = date, y = weight, color = genotype)) + 
  geom_line() +
  facet_wrap(~plant_name)
```

# Vaatame otse efekti suurusi

DEFINITION: ES = wt - mutant

**Excersise:** After reading the following code, add ht1-4 to the analysis.

```{r}
unique(plant$genotype)
unique(plant$plant_name)
```


ES tables for condition **HW_LL** (hig water, low ligth). If we have the same nr of rows in wt and mutant, we use bind_col(), otherwise we use left_join() and keep the nr of rows the same as the shorte table (in this case the mutant ht1-5 tabe)
```{r}
qy_max <- select(plant, date:genotype, QY_max) %>% 
  spread(key = genotype, value = QY_max) %>% 
  group_by(date, plant_name) %>% 
  summarise_at(vars(`Col-0`, `ht1-2`, `ht1-4`, `ht1-5`, MES5, MES7), funs(mean), na.rm = TRUE) %>% 
  mutate(ht12_es = `ht1-2` - `Col-0`, 
         ht14_es = `ht1-4` - `Col-0`,
         ht15_es = `ht1-5` - `Col-0`,
         mes5_es = MES5 - `Col-0`,
         mes7_es = MES7 - `Col-0`) %>% 
  select(date, plant_name, ends_with("es")) %>% 
  gather(key, value, ht12_es:mes7_es)
```

```{r}
ggplot(data = qy_max) +
  geom_line(mapping = aes(x = date, y = value, color = key)) +
  facet_wrap(~plant_name)
```

```{r}
temp_data <- select(plant, date:genotype, temp) %>% 
  spread(key = genotype, value = temp) %>% 
  group_by(date, plant_name) %>% 
  summarise_at(vars(`Col-0`, `ht1-2`, `ht1-4`, `ht1-5`, MES5, MES7), funs(mean), na.rm = TRUE) %>% 
  mutate(ht12_es = `ht1-2` - `Col-0`, 
         ht14_es = `ht1-4` - `Col-0`,
         ht15_es = `ht1-5` - `Col-0`,
         mes5_es = MES5 - `Col-0`,
         mes7_es = MES7 - `Col-0`) %>% 
  select(date, plant_name, ends_with("es")) %>% 
  gather(key, value, ht12_es:mes7_es)
```


```{r}
ggplot(data = temp_data) +
  geom_line(mapping = aes(x = date, y = value, color = key)) +
  facet_wrap(~plant_name)
```

```{r}
area_data <- select(plant, date:genotype, area) %>% 
  spread(key = genotype, value = area) %>% 
  group_by(date, plant_name) %>% 
  summarise_at(vars(`Col-0`, `ht1-2`, `ht1-4`, `ht1-5`, MES5, MES7), funs(mean), na.rm = TRUE) %>% 
  mutate(ht12_es = `ht1-2` - `Col-0`, 
         ht14_es = `ht1-4` - `Col-0`,
         ht15_es = `ht1-5` - `Col-0`,
         mes5_es = MES5 - `Col-0`,
         mes7_es = MES7 - `Col-0`) %>% 
  select(date, plant_name, ends_with("es")) %>% 
  gather(key, value, ht12_es:mes7_es)
```

```{r}
ggplot(data = area_data) +
  geom_line(mapping = aes(x = date, y = value, color = key)) +
  facet_wrap(~plant_name)
```

```{r}
weight_data <- select(plant, date:genotype, weight) %>% 
  spread(key = genotype, value = weight) %>% 
  group_by(date, plant_name) %>% 
  summarise_at(vars(`Col-0`, `ht1-2`, `ht1-4`, `ht1-5`, MES5, MES7), funs(mean), na.rm = TRUE) %>% 
  mutate(ht12_es = `ht1-2` - `Col-0`, 
         ht14_es = `ht1-4` - `Col-0`,
         ht15_es = `ht1-5` - `Col-0`,
         mes5_es = MES5 - `Col-0`,
         mes7_es = MES7 - `Col-0`) %>% 
  select(date, plant_name, ends_with("es")) %>% 
  gather(key, value, ht12_es:mes7_es)
```

```{r}
ggplot(data = weight_data) +
  geom_line(mapping = aes(x = date, y = value, color = key)) +
  facet_wrap(~plant_name)
```

Here we could for example model the areas accross mutants and conditions and control for temp. But to do such a thing with any meaning, I should know more about the science. 

Oh yes, date must first be converted to numeric to be fitted!
```{r}
#lm(area~date:genotye:condition  + temp, data=df_es)
```

```{r}
temp_only <- select(plant, date:genotype, temp) %>% 
  group_by(plant_id) %>% 
  mutate(day = as.numeric(date - min(date)),
         genotype = str_to_lower(str_replace_all(genotype, "[[:punct:]+]", "")),
         plant_name = str_to_lower(str_replace_all(plant_name, "[[:punct:]+]", "")),
         cond = str_c(genotype, plant_name, sep = "_")) %>% 
  ungroup()
```

```{r}
ggplot(data = temp_only) +
  geom_line(mapping = aes(x = day, y = temp, group = plant_id, color = plant_name)) +
  facet_wrap(~genotype) +
  scale_x_continuous()
```



```{r}
library(brms)
```

```{r}
f0 <- temp ~ day + cond + (1 | plant_id)
get_prior(formula = f0, data = temp_only)
mod0 <- brm(formula = f0,
            data = temp_only, 
            iter = 2400)
write_rds(mod1, "output/mod0.rds")
```

```{r}
mod0
pp_check(mod0)
marginal_effects(mod0)
```

```{r}
f1 <- temp ~ s(day) + cond + (1 | plant_id)
get_prior(formula = f1, data = temp_only)
mod1 <- brm(formula = f1,
            data = temp_only, 
            iter = 2400)
write_rds(mod1, "output/mod1_splines.rds")
```



```{r}
marginal_effects(mod1)
```


